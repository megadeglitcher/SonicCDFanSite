<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login/Register, Comment & Contact Us</title>
  <style>
    /* Basic styling */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #login-section, #comment-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ccc;
    }
    input, textarea {
      display: block;
      margin: 10px 0;
      width: 100%;
      max-width: 400px;
      padding: 8px;
    }
    button {
      padding: 8px 16px;
    }
  </style>
  <!-- All our Firebase and application code -->
  <script type="module">
    // Import Firebase libraries
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app-check.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      setDoc,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCrxSA-Y5FjKCkULoQ3iwCiKaupZOSK9FU",
      authDomain: "soniccdfansite.firebaseapp.com",
      projectId: "soniccdfansite",
      storageBucket: "soniccdfansite.firebasestorage.app",
      messagingSenderId: "739250141699",
      appId: "1:739250141699:web:1925788f3944b1aa58ac36",
      measurementId: "G-EQK0WQWQ33"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // Initialize App Check with your reCAPTCHA v3 site key
    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LdBNdkqAAAAAIh8NW8oqzlKemtRTOeV-To_Y9g8'),
      isTokenAutoRefreshEnabled: true
    });

    // Initialize Firestore and Auth
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Utility functions for cookies and messages
    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      const expires = "expires=" + date.toUTCString();
      document.cookie = name + "=" + value + ";" + expires + ";path=/";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(";");
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) {
          return c.substring(nameEQ.length, c.length);
        }
      }
      return null;
    }

    function eraseCookie(name) {
      document.cookie = name + "=; Max-Age=-99999999;";
    }

    function displayMessage(elementId, message, isError = true) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.style.color = isError ? "red" : "green";
      setTimeout(() => {
        element.textContent = "";
      }, 5000);
    }

    // Retrieve logged in user (if any) from cookies
    let loggedInUser = getCookie("loggedInUser");

    // Register a new user (data stored in Firestore "users" collection)
    async function registerUser(username, password) {
      username = username.trim();
      if (/\s/.test(username)) {
        displayMessage("register-error-message", "Username cannot contain spaces!");
        return;
      }
      if (!username) {
        displayMessage("register-error-message", "Username cannot be empty or just whitespace!");
        return;
      }
      try {
        const userDoc = await getDoc(doc(db, "users", username));
        if (userDoc.exists()) {
          displayMessage("register-error-message", "Username already in use!");
          return;
        }
        const createdAt = new Date().toISOString();
        await setDoc(doc(db, "users", username), {
          username,
          password,
          createdAt
        });
        displayMessage("register-error-message", "User registered successfully!", false);
      } catch (e) {
        displayMessage("register-error-message", "Error registering user.");
      }
    }

    // Login an existing user
    async function loginUser(username, password) {
      username = username.trim();
      if (/\s/.test(username)) {
        displayMessage("login-error-message", "Username cannot contain spaces!");
        return;
      }
      if (!username) {
        displayMessage("login-error-message", "Username cannot be empty or just whitespace!");
        return;
      }
      try {
        const userDoc = await getDoc(doc(db, "users", username));
        if (!userDoc.exists()) {
          displayMessage("login-error-message", "Username does not exist!");
          return;
        }
        const userData = userDoc.data();
        if (userData.password === password) {
          loggedInUser = username;
          setCookie("loggedInUser", username, 1993);
          displayMessage("login-error-message", "User logged in successfully!", false);
          document.getElementById("login-section").style.display = "none";
          document.getElementById("comment-section").style.display = "block";
          loadComments();
        } else {
          displayMessage("login-error-message", "Incorrect password!");
        }
      } catch (e) {
        displayMessage("login-error-message", "Error logging in.");
      }
    }
    window.registerUser = registerUser;
    window.loginUser = loginUser;

    // Determine comments collection based on current page name
    const currentPage = window.location.pathname.split("/").pop().split(".")[0];
    const commentsCollectionName = `comments-${currentPage}`;

    // Submit a comment (requires the user to be logged in)
    async function submitComment() {
      if (!loggedInUser) {
        alert("You need to be logged in to do that.");
        return;
      }
      const comment = document.getElementById("comment").value.trim();
      if (!comment) {
        alert("Comment cannot be blank!");
        return;
      }
      const createdAt = new Date().toISOString();
      try {
        await addDoc(collection(db, commentsCollectionName), {
          name: loggedInUser,
          comment,
          createdAt
        });
        document.getElementById("comment").value = "";
      } catch (e) {
        console.error("Error adding comment:", e);
      }
    }
    window.submitComment = submitComment;

    // Log off the user
    window.logOff = function() {
      eraseCookie("loggedInUser");
      loggedInUser = null;
      displayMessage("login-error-message", "You have been logged out.", false);
      document.getElementById("login-section").style.display = "block";
      document.getElementById("comment-section").style.display = "none";
    };

    // Load comments from Firestore and update the UI live
    function loadComments() {
      const commentsRef = collection(db, commentsCollectionName);
      const commentsQuery = query(commentsRef, orderBy("createdAt", "desc"));
      onSnapshot(commentsQuery, (snapshot) => {
        const commentsContainer = document.getElementById("comments-container");
        commentsContainer.innerHTML = "";
        snapshot.forEach((doc) => {
          const commentData = doc.data();
          const commentElement = document.createElement("div");
          const commentText = document.createElement("p");
          const commentTimestamp = document.createElement("p");
          if (commentData.name === "SDG") {
            commentText.appendChild(rainbowText(`${commentData.name}: `, true));
            const commentParts = commentData.comment.split("\n").map((part) => rainbowText(part));
            commentParts.forEach((part) => {
              commentText.appendChild(part);
              commentText.appendChild(document.createElement("br"));
            });
            applyOutlineStyle(commentText);
          } else {
            commentText.textContent = `${commentData.name}: ${commentData.comment}`;
          }
          commentTimestamp.textContent = new Date(commentData.createdAt).toLocaleString();
          commentTimestamp.style.fontSize = "small";
          commentTimestamp.style.fontStyle = "italic";
          commentTimestamp.style.color = "rgba(0, 0, 0, 0.6)";
          commentTimestamp.style.marginTop = "-10px";
          commentElement.appendChild(commentText);
          commentElement.appendChild(commentTimestamp);
          commentsContainer.appendChild(commentElement);
        });
      });
    }
    window.loadComments = loadComments;

    // Utility: Rainbow text effect (for special user "SDG")
    function rainbowText(text, reverse = false) {
      const colors = ["red", "orange", "yellow", "green", "blue", "indigo", "violet"];
      if (reverse) colors.reverse();
      const span = document.createElement("span");
      for (let i = 0; i < text.length; i++) {
        const charSpan = document.createElement("span");
        charSpan.style.color = colors[i % colors.length];
        charSpan.textContent = text[i];
        span.appendChild(charSpan);
      }
      return span;
    }

    // Utility: Apply outline style for "SDG" comments
    function applyOutlineStyle(element) {
      element.style.webkitTextStroke = "0.5px black";
      element.style.color = "white";
    }

    // Change password function
    window.changePassword = async function(username, currentPassword, newPassword) {
      username = username.trim();
      currentPassword = currentPassword.trim();
      newPassword = newPassword.trim();
      if (!username || !currentPassword || !newPassword) {
        alert("All fields are required.");
        return;
      }
      try {
        const userDoc = await getDoc(doc(db, "users", username));
        if (!userDoc.exists()) {
          alert("Username does not exist!");
          return;
        }
        const userData = userDoc.data();
        if (userData.password !== currentPassword) {
          alert("Current password is incorrect!");
          return;
        }
        await setDoc(doc(db, "users", username), { ...userData, password: newPassword }, { merge: true });
        alert("Password changed successfully!");
      } catch (e) {
        alert("Error changing password.");
      }
    };

    // Window onload: Setup sections based on login status and handle contact form
    window.onload = function() {
      loadComments();
      if (loggedInUser) {
        document.getElementById("login-section").style.display = "none";
        document.getElementById("comment-section").style.display = "block";
      } else {
        document.getElementById("login-section").style.display = "block";
        document.getElementById("comment-section").style.display = "none";
      }

      // (Optional) Developer tools detector for non-"SDG" users
      if (loggedInUser !== "SDG") {
        const detectDevTools = () => {
          const threshold = 160;
          const isDevToolsOpen = () => {
            return (
              window.outerWidth - window.innerWidth > threshold ||
              window.outerHeight - window.innerHeight > threshold
            );
          };
          if (isDevToolsOpen()) {
            window.close();
            setTimeout(() => { window.location.href = "about:blank"; }, 500);
          }
        };
        const checkDevTools = () => {
          detectDevTools();
          requestAnimationFrame(checkDevTools);
        };
        requestAnimationFrame(checkDevTools);
      }

      // Contact form handling
      const contactForm = document.getElementById("contact-form");
      contactForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("contact-username").value;
        const email = document.getElementById("contact-email").value;
        const subject = document.getElementById("contact-subject").value;
        const message = document.getElementById("contact-message").value;
        try {
          await addDoc(collection(db, "contactMessages"), {
            name,
            email,
            subject,
            message,
            createdAt: new Date().toISOString()
          });
          document.getElementById("contact-status-message").textContent = "Message sent successfully!";
          document.getElementById("contact-status-message").style.color = "green";
          contactForm.reset();
        } catch (error) {
          document.getElementById("contact-status-message").textContent = "Error sending message.";
          document.getElementById("contact-status-message").style.color = "red";
        }
      });
    };
  </script>
</head>
<body>
  <!-- Login/Register Section -->
  <div id="login-section">
    <h1>Login/Register</h1>
    <div>
      <h2>Register</h2>
      <input type="text" id="register-username" placeholder="Username" />
      <input type="password" id="register-password" placeholder="Password" />
      <button onclick="registerUser(document.getElementById('register-username').value, document.getElementById('register-password').value)">Register</button>
      <p id="register-error-message" style="color: red;"></p>
    </div>
    <div>
      <h2>Login</h2>
      <input type="text" id="login-username" placeholder="Username" />
      <input type="password" id="login-password" placeholder="Password" />
      <button onclick="loginUser(document.getElementById('login-username').value, document.getElementById('login-password').value)">Login</button>
      <p id="login-error-message" style="color: red;"></p>
    </div>
  </div>

  <!-- Comment Section -->
  <div id="comment-section" style="display: none;">
    <h1>Comment Section</h1>
    <div>
      <textarea id="comment" placeholder="Write your comment here"></textarea>
      <button onclick="submitComment()">Submit</button>
    </div>
    <button onclick="logOff()">Log Off</button>
    <div>
      <h2>Change Password</h2>
      <input type="text" id="change-username" placeholder="Username" />
      <input type="password" id="current-password" placeholder="Current Password" />
      <input type="password" id="new-password" placeholder="New Password" />
      <button onclick="changePassword(document.getElementById('change-username').value, document.getElementById('current-password').value, document.getElementById('new-password').value)">Change Password</button>
      <p id="change-password-error-message" style="color: red;"></p>
    </div>
    <div id="comments-container">
      <!-- Comments will load here -->
    </div>
  </div>

  <!-- Contact Us Form -->
  <h1>Contact Us</h1>
  <form id="contact-form">
    <input type="text" id="contact-username" placeholder="Your Name" required />
    <input type="email" id="contact-email" placeholder="Your Email" required />
    <input type="text" id="contact-subject" placeholder="Subject" required />
    <textarea id="contact-message" placeholder="Your Message" required></textarea>
    <button type="submit">Send Message</button>
  </form>
  <p id="contact-status-message"></p>
</body>
</html>
